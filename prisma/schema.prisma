generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Board {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title           String
  description     String?
  backgroundColor String          @db.VarChar(7)
  workspaceId     String          @db.Uuid
  ownerId         String?         @db.Uuid
  createdAt       DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime        @default(now()) @db.Timestamptz(6)
  Member          Member?         @relation(fields: [ownerId], references: [id])
  Workspace       Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  Card            Card[]
  Label           Label[]
  List            List[]
  FavoriteBoard   FavoriteBoard[]
}

model Card {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title        String
  description  String?
  listId       String?        @db.Uuid
  boardId      String         @db.Uuid
  position     String
  priority     CardPriority
  status       CardStatus     @default(UNKNOWN)
  createdAt    DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime       @default(now()) @db.Timestamptz(6)
  List         List?          @relation(fields: [listId], references: [id], onDelete: Cascade)
  Board        Board          @relation(fields: [boardId], references: [id], onDelete: Cascade)
  CardAssignee CardAssignee[]
  CardLabel    CardLabel[]
  Comment      Comment[]

  @@index([listId, position])
}

model CardAssignee {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cardId    String   @db.Uuid
  memberId  String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  Card      Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  Member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, cardId], map: "idx_card_assignee_unique")
}

model CardLabel {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cardId  String @db.Uuid
  labelId String @db.Uuid
  Card    Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)
  Label   Label  @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([labelId, cardId], map: "idx_card_label_unique")
}

model Comment {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  memberId  String?  @db.Uuid
  cardId    String?  @db.Uuid
  content   String
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @db.Timestamptz(6)
  Card      Card?    @relation(fields: [cardId], references: [id], onDelete: Cascade)
  Member    Member?  @relation(fields: [memberId], references: [id])
}

model Invitation {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId  String           @db.Uuid
  inviteeEmail String
  role         WorkspaceRole
  inviterId    String           @db.Uuid
  status       InvitationStatus @default(PENDING)
  createdAt    DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime         @default(now()) @db.Timestamptz(6)
  Member       Member           @relation(fields: [inviterId], references: [id], onDelete: Cascade)
  Workspace    Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Label {
  id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title     String
  color     String      @db.VarChar(7)
  boardId   String      @db.Uuid
  createdAt DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt DateTime    @default(now()) @db.Timestamptz(6)
  CardLabel CardLabel[]
  Board     Board       @relation(fields: [boardId], references: [id], onDelete: Cascade)
}

model List {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  boardId   String   @db.Uuid
  title     String
  position  String
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @db.Timestamptz(6)
  Card      Card[]
  Board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId, position])
}

model Member {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String            @unique
  password        String?
  nickname        String?           @unique
  role            MemberRole        @default(USER)
  imageUrl        String?
  createdAt       DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime          @default(now()) @db.Timestamptz(6)
  Board           Board[]
  CardAssignee    CardAssignee[]
  Comment         Comment[]
  Invitation      Invitation[]
  Workspace       Workspace[]
  WorkspaceMember WorkspaceMember[]
  FavoriteBoard   FavoriteBoard[]
}

model Workspace {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  ownerId         String            @db.Uuid
  description     String?
  createdAt       DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime          @default(now()) @db.Timestamptz(6)
  Board           Board[]
  Invitation      Invitation[]
  Member          Member            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  WorkspaceMember WorkspaceMember[]

  @@unique([ownerId, name], map: "idx_workspace_owner_name")
}

model WorkspaceMember {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String        @db.Uuid
  memberId    String        @db.Uuid
  role        WorkspaceRole
  joinAt      DateTime      @default(now()) @db.Timestamptz(6)
  createdAt   DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime      @default(now()) @db.Timestamptz(6)
  Member      Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  Workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, memberId], map: "idx_workspace_member_unique")
}

model FavoriteBoard {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  memberId  String   @db.Uuid
  boardId   String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  Member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  Board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@unique([memberId, boardId], map: "idx_favorite_board_unique")
}

enum CardPriority {
  HIGH
  MEDIUM
  LOW
}

enum CardStatus {
  TODO
  IN_PROGRESS
  DONE
  UNKNOWN
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum MemberRole {
  USER
  ADMIN
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}
